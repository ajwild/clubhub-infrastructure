# clubhub-infrastructure

## Enable APIs

- [Cloud Resource Manager](https://console.developers.google.com/apis/library/cloudresourcemanager.googleapis.com)

## Setup Terraform user

Create Terraform [service account](https://console.cloud.google.com/iam-admin/serviceaccounts) with
the following permissions:

- Cloud Build Editor
- Cloud Run Admin
- Firebase Admin
- Secret Manager Admin
- Service Account User
- Service Usage Admin
- Storage Admin
- Viewer 

Create a key and export it as JSON.

## Connect GitHub repository

Add the [Cloud Build GitHub App](https://console.cloud.google.com/cloud-build/triggers/connect), but
skip the create trigger step.

## Create Firebase token

`npx firebase login:ci`

## Run Terraform

```
terraform init
terraform apply
```

Lots of tasks will produce errors, but the [workspace](https://app.terraform.io/app) will be
created.

## Collect and add variables to Terraform

Add all variables that you can to begin with:

- project (GCP project name e.g. test-1234)
- region (GCP default region e.g. us-central1)
<!-- - storage_region (GCP default storage region e.g. US) -->
- web_app_nickname (Firebase name of app e.g. nextjs)
- web_repository_owner (GitHub owner of web app e.g. example-org)
- web_repository_name (GitHub name of web app e.g. clubhub-web)
- web_repository_branch (GitHub branch of web app to deploy e.g. master)
- credentials (Contents of GCP service account key JSON file created for Terraform)
- SESSION_SECRET_CURRENT (Random string used for session cookies e.g. dCyfAjbaXhS6VoHFN96p)
- SESSION_SECRET_PREVIOUS (Random string used for session cookies e.g. U5yp3zGuXHNvQKJMDWgy)
- FIREBASE_TOKEN (Generated by `firebase login:ci` e.g. 1//03kP...N6Vk)

## Get new variables from Firebase and add to Terraform

This part could be automated, but is currently a manual step.

Open the [Firebase console](https://console.firebase.google.com/) and go to Project settings. While
on the General tab use the data in the "Firebase SDK snippet" to complete. See the repository for
the expected data and layout.

- WEB_ENV (web app default .env file with public data for Next.js)

Next go to the service accounts tab. Click on the "Generate new private key" button. Use the data to
populate the following variables:

- FIREBASE_CLIENT_EMAIL (e.g. firebase-adminsdk-abc12@project-name.iam.gserviceaccount.com)
- FIREBASE_PRIVATE_KEY (e.g. -----BEGIN PRIVATE KEY-----\nMIIE...ZfOi\n-----END PRIVATE KEY-----\n)

## Add permissions to the Cloud Build service account

Assign the following roles to the Cloud Build service account
(e.g. 123456789012@cloudbuild.gserviceaccount.com):

- Cloud Run Admin
- Firebase Viewer
- Service Account User

Note: Unable to find a way to do this without elevating the permissions of the Terraform service
account.

## Run Terraform again

```
terraform apply
```

Hopefully it works!
